####
# Nginx configuration.
####

# Set cache path.
proxy_cache_path /data/nginx/cache_web levels=1:2 keys_zone=cache_web:10m max_size=1g inactive=45m use_temp_path=off;
# Set map bucket size.
# map_hash_bucket_size 256;

map $sent_http_content_type $expires {
#     "text/html"                epoch; # Sets the expiration to epoch for all html files.
#     "text/html;charset=UTF-8"  epoch; # Sets the expiration to epoch for all html files.
#    "text/html"                 30m;
#    "text/html;charset=UTF-8"   30m;
    "text/css"                  30d;
    "text/css; charset=utf-8"   30d;
    "text/javascript"           30d;
    "text/javascript; charset=utf-8" 30d;
    "application/javascript"    30d;
    "application/javascript; charset=utf-8" 30d;
    "font/woff2"                30d;
    "image/x-icon"              30d;
    "image/jpeg"                30d;
    "image/png"                 30d;
    default                     off;
}

upstream nuxt_application {
    server 127.0.0.1:3000;
    keepalive 64;
}

# Redirect Map (301 redirects).
map $request_uri $new_uri {
    include /etc/nginx/nginx-redirects.map; #or any file readable by nginx
}

# Redirect tp https
# server {
#          server_name "~^www\.(.*)$" ;
#          return 301 $scheme://$1$request_uri ;
# }

# Redirect to main domain
#server {
#    listen 80;
#    listen [::]:80;
#    server_name .ondigitalocean.app;
#
#    return 301 https://checkmate.dk$request_uri;
#}

server {

    listen 80;
    listen [::]:80;

    server_name     _;    # setup your domain(s) here

    # Security headers.
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    # Sets HSTS header.
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    gzip            on;
    gzip_vary       on;
    # gzip_types      text/plain text/xml application/xml text/css application/javascript application/json image/svg+xml application/vnd.ms-fontobject application/x-font-ttf font/opentype application/octet-stream;
    gzip_types      text/plain text/xml application/xml text/css text/javascript application/javascript application/x-javascript text/x-component application/json application/xhtml+xml application/rss+xml application/atom+xml #application/vnd.ms-fontobject image/svg+xml application/x-font-ttf font/opentype application/octet-stream
    gzip_proxied    no-cache no-store private expired auth;
    gzip_min_length 1000;
    gzip_disable "MSIE [1-6]\.";

    #gzip on;
    #gzip_min_length 100;
    #gzip_types text/plain text/xml application/xml text/css text/javascript application/javascript application/x-javascript text/x-component application/json application/xhtml+xml application/rss+xml application/atom+xml #application/vnd.ms-fontobject image/svg+xml application/x-font-ttf font/opentype application/octet-stream;
    #gzip_comp_level 1;
    #gzip_disable "MSIE [1-6]\.";
    #expires 1h;

    client_max_body_size 32M;
    client_body_buffer_size 32M;
    fastcgi_buffers 8 3200k;
    fastcgi_buffer_size 6400k;
    fastcgi_connect_timeout 60s;
    fastcgi_send_timeout 60s;
    fastcgi_read_timeout 60s;

    location / {
        expires $expires;

        # Redirect
        if ($new_uri != "") {
            rewrite ^(.*)$ $new_uri permanent;
        }

        proxy_redirect                      off;
        sub_filter_last_modified            on;
        proxy_cache_revalidate              on;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header Connection         "";
        proxy_read_timeout                  1m;
        proxy_connect_timeout               1m;
        proxy_http_version                  1.1;
        # proxy_cache                         cache_web;
        proxy_pass                          http://nuxt_application; # set the address of the Node.js instance here

        # Adds trailing slash to URls.
        rewrite ^([^.]*[^/])$ $1/ permanent;

    }

    # deny access to .htaccess files, if Apache's document root concurs with nginx's one
    location ~ /\.(?!well-known).* {
           deny all;
    }

    # Pass to the reverese proxy
    location /wp-content/uploads {
        location ~* \.(jpg|pdf|png|jpeg|webp|gif|mp4|ico|avif)$ {
            proxy_redirect                      off;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host   $host;
            # proxy_set_header X-Forwarded-Proto  $scheme;
            # proxy_set_header Connection         "";
            proxy_http_version                  1.1;
            proxy_read_timeout                  15s;
            proxy_connect_timeout               15s;
            proxy_pass http://127.0.0.1:8080;
        }
    }

#     location /-/healthz {
#         expires -1;
#     }
#
#     # Set expiration for images.
#     location ~* \.(jpg|pdf|png|jpeg|webp)$ {
#         expires 30d;
#     }

#     location ~* \.(js|css)$ {
#         expires 1d;
#         add_header Cache-Control "public, no-transform";
#     }


}
